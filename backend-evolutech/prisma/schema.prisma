generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  fullName     String     @map("full_name")
  passwordHash String?    @map("password_hash")
  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  auditLogs    AuditLog[]
  tasks        Task[]
  roles        UserRole[]

  @@map("profiles")
}

model Company {
  id             String          @id @default(uuid())
  name           String
  slug           String          @unique
  document       String?
  plan           String          @default("free")
  status         Status          @default(active)
  logoUrl        String?         @map("logo_url")
  monthlyRevenue Decimal?        @default(0) @map("monthly_revenue") @db.Decimal(10, 2)
  sistemaBaseId  String?         @map("sistema_base_id")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  appointments   Appointment[]
  appointmentServices AppointmentService[]
  appointmentAvailability AppointmentAvailability[]
  auditLogs      AuditLog[]
  sistemaBase    SistemaBase?    @relation(fields: [sistemaBaseId], references: [id])
  customers      Customer[]
  modules        CompanyModule[]
  orders         Order[]
  products       Product[]
  tasks          Task[]
  userRoles      UserRole[]
  paymentGateways PaymentGateway[]
  paymentTransactions PaymentTransaction[]
  billingCharges BillingCharge[]

  @@index([sistemaBaseId])
  @@map("companies")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  companyId String?  @map("company_id")
  role      Role
  createdAt DateTime @default(now()) @map("created_at")
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([companyId])
  @@index([userId])
  @@map("user_roles")
}

model Modulo {
  id           String              @id @default(uuid())
  nome         String
  codigo       String              @unique
  descricao    String?
  icone        String?
  nicho        String?             @default("geral")
  precoMensal  Decimal             @default(0) @map("preco_mensal") @db.Decimal(10, 2)
  isCore       Boolean             @default(false) @map("is_core")
  status       Status              @default(active)
  createdAt    DateTime            @default(now()) @map("created_at")
  empresas     CompanyModule[]
  sistemasBase SistemaBaseModulo[]

  @@map("modulos")
}

model SistemaBase {
  id        String              @id @default(uuid())
  nome      String              @unique
  descricao String?
  categoria String?
  icone     String?
  isActive  Boolean             @default(true) @map("is_active")
  createdAt DateTime            @default(now()) @map("created_at")
  empresas  Company[]
  modulos   SistemaBaseModulo[]

  @@map("sistema_base")
}

model SistemaBaseModulo {
  id            String      @id @default(uuid())
  sistemaBaseId String      @map("sistema_base_id")
  moduloId      String      @map("modulo_id")
  isMandatory   Boolean     @default(false) @map("is_mandatory")
  modulo        Modulo      @relation(fields: [moduloId], references: [id], onDelete: Cascade)
  sistemaBase   SistemaBase @relation(fields: [sistemaBaseId], references: [id], onDelete: Cascade)

  @@unique([sistemaBaseId, moduloId])
  @@map("sistema_base_modulos")
}

model CompanyModule {
  id          String    @id @default(uuid())
  companyId   String    @map("empresa_id")
  moduloId    String    @map("modulo_id")
  isActive    Boolean   @default(true) @map("is_active")
  activatedAt DateTime? @default(now()) @map("activated_at")
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  modulo      Modulo    @relation(fields: [moduloId], references: [id], onDelete: Cascade)

  @@unique([companyId, moduloId])
  @@index([companyId])
  @@index([moduloId])
  @@map("empresa_modulos")
}

model Customer {
  id        String   @id @default(uuid())
  companyId String   @map("empresa_id")
  name      String
  email     String?
  phone     String?
  document  String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("customers")
}

model Product {
  id            String   @id @default(uuid())
  companyId     String   @map("empresa_id")
  name          String
  sku           String?
  price         Decimal  @db.Decimal(10, 2)
  stockQuantity Int      @default(0) @map("stock_quantity")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("products")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  companyId String?  @map("empresa_id")
  action    String
  resource  String
  details   Json?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")
  company   Company? @relation(fields: [companyId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}


model Order {
  id           String   @id @default(uuid())
  companyId    String   @map("empresa_id")
  customerName String?  @map("customer_name")
  total        Decimal  @default(0) @db.Decimal(10, 2)
  status       String   @default("pending")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  paymentTransactions PaymentTransaction[]
  billingCharge BillingCharge?

  @@map("orders")
}

model PaymentGateway {
  id                String   @id @default(uuid())
  companyId         String   @map("empresa_id")
  provider          String   @map("provedor")
  displayName       String   @map("nome_exibicao")
  publicKey         String?  @map("public_key")
  secretKeyEncrypted String? @map("secret_key_encrypted")
  webhookSecretEncrypted String? @map("webhook_secret_encrypted")
  environment       String   @default("sandbox") @map("ambiente")
  isActive          Boolean  @default(false) @map("is_active")
  webhookUrl        String?  @map("webhook_url")
  settings          Json?    @map("configuracoes")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions      PaymentTransaction[]

  @@unique([companyId, provider])
  @@index([companyId, isActive])
  @@map("payment_gateways")
}

model PaymentTransaction {
  id                String   @id @default(uuid())
  companyId         String   @map("empresa_id")
  orderId           String   @map("order_id")
  gatewayId         String?  @map("gateway_id")
  provider          String
  paymentMethod     String   @map("payment_method")
  externalPaymentId String?  @map("external_payment_id")
  status            String   @default("pending")
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("brl")
  qrCodeText        String?  @map("qr_code_text")
  qrCodeImageUrl    String?  @map("qr_code_image_url")
  paymentLinkUrl    String?  @map("payment_link_url")
  gatewayResponse   Json?    @map("gateway_response")
  paidAt            DateTime? @map("paid_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  gateway           PaymentGateway? @relation(fields: [gatewayId], references: [id], onDelete: SetNull)

  @@index([companyId, status, createdAt])
  @@index([externalPaymentId, provider])
  @@map("payment_transactions")
}

model BillingCharge {
  id            String   @id @default(uuid())
  companyId     String   @map("empresa_id")
  orderId       String   @unique @map("order_id")
  title         String
  description   String?
  customerName  String   @map("customer_name")
  customerEmail String?  @map("customer_email")
  customerPhone String?  @map("customer_phone")
  amount        Decimal  @db.Decimal(10, 2)
  paymentMethod String   @default("pix") @map("payment_method")
  status        String   @default("pending")
  dueDate       DateTime? @map("due_date")
  paidAt        DateTime? @map("paid_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([companyId, status, createdAt])
  @@map("billing_charges")
}

model Task {
  id          String     @id @default(uuid())
  companyId   String     @map("empresa_id")
  userId      String     @map("user_id")
  title       String
  description String?
  status      TaskStatus @default(todo)
  position    Int        @default(0)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId, userId])
  @@index([companyId, userId, status, position])
  @@map("tasks")
}

model Appointment {
  id           String   @id @default(uuid())
  companyId    String   @map("empresa_id")
  serviceId    String?  @map("service_id")
  professionalId String? @map("professional_id")
  customerName String   @map("customer_name")
  serviceName  String   @map("service_name")
  professionalName String?  @map("professional_name")
  scheduledAt  DateTime @map("scheduled_at")
  status       String   @default("scheduled")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  service      AppointmentService? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  @@index([companyId, serviceId])
  @@index([companyId, professionalId, scheduledAt])

  @@map("appointments")
}

model AppointmentService {
  id              String   @id @default(uuid())
  companyId       String   @map("empresa_id")
  name            String
  description     String?
  durationMinutes Int      @default(30) @map("duration_minutes")
  price           Decimal? @db.Decimal(10, 2)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  appointments    Appointment[]

  @@index([companyId, isActive])
  @@map("appointment_services")
}

model AppointmentAvailability {
  id             String   @id @default(uuid())
  companyId      String   @map("empresa_id")
  professionalId String   @map("professional_id")
  weekday        Int
  startTime      String   @map("start_time")
  endTime        String   @map("end_time")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, professionalId, weekday, startTime, endTime])
  @@index([companyId, professionalId, weekday, isActive])
  @@map("appointment_availability")
}


enum Role {
  SUPER_ADMIN_EVOLUTECH
  ADMIN_EVOLUTECH
  DONO_EMPRESA
  FUNCIONARIO_EMPRESA
}

enum Status {
  active
  inactive
  pending
}

enum TaskStatus {
  todo
  doing
  done
}
